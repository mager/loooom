name: Plugin Quality Eval

on:
  push:
    branches: [main]
    paths:
      - "plugins/*/promptfooconfig.yaml"
      - "plugins/*/skills/**"
  schedule:
    - cron: "0 2 * * *" # nightly 02:00 UTC
  workflow_dispatch:

jobs:
  eval:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # full history needed for git log change detection

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install promptfoo
        run: npm install -g promptfoo

      - name: Run evals (changed plugins only)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          mkdir -p /tmp/eval-results

          node -e "
          const { execSync } = require('child_process');
          const fs = require('fs');

          const pluginMap = [
            { slug: 'beginner-japanese', key: 'mager/beginner-japanese' },
            { slug: 'kana-ascii',        key: 'mager/kana-ascii' },
            { slug: 'learn-anything',    key: 'loooom/learn-anything' },
            { slug: 'socratic-thinking', key: 'loooom/socratic-thinking' },
            { slug: 'persuasive-writing',key: 'loooom/persuasive-writing' },
            { slug: 'frontend-design',   key: 'mager/frontend-design' },
          ];

          const scores = JSON.parse(fs.readFileSync('eval-scores.json', 'utf8'));
          const head = execSync('git rev-parse HEAD').toString().trim();

          const toRun = pluginMap.filter(({ slug, key }) => {
            const lastCommit = scores.plugins[key]?.lastCommit;
            if (!lastCommit) {
              console.log(\`\${slug}: no prior eval — running\`);
              return true;
            }
            const changes = execSync(\`git log --oneline \${lastCommit}..HEAD -- plugins/\${slug}/\`).toString().trim();
            if (changes) {
              console.log(\`\${slug}: changed since \${lastCommit.slice(0,7)} — running\`);
              return true;
            }
            console.log(\`\${slug}: no changes — skipping\`);
            return false;
          });

          fs.writeFileSync('/tmp/to-run.json', JSON.stringify(toRun));
          fs.writeFileSync('/tmp/head-sha.txt', head);
          "

          # Run evals for changed plugins only
          node -e "
          const { execSync } = require('child_process');
          const fs = require('fs');
          const toRun = JSON.parse(fs.readFileSync('/tmp/to-run.json'));

          for (const { slug } of toRun) {
            console.log(\`\n→ Evaluating \${slug}...\`);
            try {
              execSync(
                \`npx promptfoo eval --config plugins/\${slug}/promptfooconfig.yaml --output /tmp/eval-results/\${slug}.json\`,
                { stdio: 'inherit' }
              );
            } catch {
              console.log(\`  ⚠ eval failed for \${slug} — keeping previous score\`);
            }
          }
          "

      - name: Aggregate scores
        run: |
          node -e "
          const fs = require('fs');

          const pluginMap = [
            { slug: 'beginner-japanese', key: 'mager/beginner-japanese' },
            { slug: 'kana-ascii',        key: 'mager/kana-ascii' },
            { slug: 'learn-anything',    key: 'loooom/learn-anything' },
            { slug: 'socratic-thinking', key: 'loooom/socratic-thinking' },
            { slug: 'persuasive-writing',key: 'loooom/persuasive-writing' },
            { slug: 'frontend-design',   key: 'mager/frontend-design' },
          ];

          const toRun = JSON.parse(fs.readFileSync('/tmp/to-run.json'));
          const head = fs.readFileSync('/tmp/head-sha.txt', 'utf8').trim();
          const scores = JSON.parse(fs.readFileSync('eval-scores.json', 'utf8'));
          const ranSlugs = new Set(toRun.map(p => p.slug));

          scores.updatedAt = new Date().toISOString();

          for (const { slug, key } of pluginMap) {
            if (!ranSlugs.has(slug)) continue; // didn't run — preserve existing score

            const file = \`/tmp/eval-results/\${slug}.json\`;
            if (!fs.existsSync(file)) continue; // eval failed — preserve existing score

            try {
              const data = JSON.parse(fs.readFileSync(file, 'utf8'));
              const results = data.results?.results || [];
              const total = results.length;
              const passed = results.filter(r => r.success).length;
              const score = total > 0 ? Math.round((passed / total) * 100) : 0;
              scores.plugins[key] = {
                score,
                passed,
                total,
                status: score >= 80 ? 'passing' : score === 0 && total === 0 ? 'pending' : 'failing',
                lastCommit: head,
              };
            } catch {
              console.log(\`Failed to parse results for \${slug}\`);
            }
          }

          fs.writeFileSync('eval-scores.json', JSON.stringify(scores, null, 2));
          console.log(JSON.stringify(scores, null, 2));
          "

      - name: Commit scores
        run: |
          git config user.name "Loooom Eval Bot"
          git config user.email "bot@loooom.xyz"
          git add eval-scores.json
          git diff --cached --quiet || git commit -m "ci: update eval scores [skip ci]"
          git push
